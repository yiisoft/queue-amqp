version: "3.5"

services:
  php80:
    container_name: yii-queue-amqp-php80
    build:
      context: ..
      dockerfile: tests/docker/php/Dockerfile
      args:
        PHP_VERSION: '8.0'
    volumes:
      - ./runtime/.composer80:/root/.composer
      - ..:/var/www
    dns: &php_dns
      - 8.8.8.8
      - 1.1.1.1
    environment: &php_environment
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
    depends_on: &php_depends_on
      rabbitmq:
        condition: service_healthy
    networks: &networks
      net: { }

  php81:
    container_name: yii-queue-amqp-php81
    build:
      context: ..
      dockerfile: tests/docker/php/Dockerfile
      args:
        PHP_VERSION: '8.1'
    volumes:
      - ./runtime/.composer81:/root/.composer
      - ..:/var/www
    dns: *php_dns
    environment: *php_environment
    depends_on: *php_depends_on
    networks: *networks

  php82:
    container_name: yii-queue-amqp-php82
    build:
      context: ..
      dockerfile: tests/docker/php/Dockerfile
      args:
        PHP_VERSION: '8.2'
    volumes:
      - ./runtime/.composer82:/root/.composer
      - ..:/var/www
    dns: *php_dns
    environment: *php_environment
    depends_on: *php_depends_on
    networks: *networks

  rabbitmq:
    image: rabbitmq:alpine
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 3s
      timeout: 5s
      retries: 3
    networks:
      net: { }

networks:
  net:
    name: yii-queue-amqp
