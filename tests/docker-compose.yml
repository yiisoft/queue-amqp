version: "3.5"

services:
  php80:
    container_name: yii-queue-php80
    build:
      context: ..
      dockerfile: tests/docker/php/Dockerfile
      args:
        PHP_VERSION: '8.0'

    dns: &php_dns
      - 8.8.8.8
      - 1.1.1.1
    environment: &php_environment
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
    depends_on: &php_depends_on
      rabbitmq:
        condition: service_healthy

  php81:
    container_name: yii-queue-php81
    build:
      context: ..
      dockerfile: tests/docker/php/Dockerfile
      args:
        PHP_VERSION: '8.1'

    dns: *php_dns
    environment: *php_environment
    depends_on: *php_depends_on

  php82:
    container_name: yii-queue-php82
    build:
      context: ..
      dockerfile: tests/docker/php/Dockerfile
      args:
        PHP_VERSION: '8.2'

    dns: *php_dns
    environment: *php_environment
    depends_on: *php_depends_on

  rabbitmq:
    image: rabbitmq:alpine
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 3s
      timeout: 5s
      retries: 3
